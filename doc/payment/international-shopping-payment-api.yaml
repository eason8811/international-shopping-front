openapi: 3.1.0
info:
  title: 默认模块
  description: >
    - 统一鉴权：Cookie 会话（HttpOnly `access_token`）<br/> - 统一返回包裹结构（所有 HTTP
    状态码均使用相同结构）<br/> - CSRF 防护：双提交（Header: `X-CSRF-Token` 与 Cookie: `csrf_token`
    必须相等）<br/> - 匿名接口：显式 `security: []`<br/>
  version: 1.3.0
tags:
  - name: payment
  - name: payment/Payments
  - name: payment/PayPalWebhook
  - name: payment/OpsSync
  - name: payment/AdminPayments
  - name: payment/AdminRefunds
  - name: Payments
  - name: PayPalWebhook
  - name: OpsSync
  - name: AdminPayments
  - name: AdminRefunds
paths:
  /payments/paypal/checkout:
    post:
      summary: 创建 PayPal Checkout（返回收银台跳转链接）
      deprecated: false
      description: >
        ### 目的

        用户点击“去支付”时调用：创建/复用支付单并向 PayPal 创建 Order，返回 `approve_url`。


        ### 关键约定

        - **幂等**：同一订单 + 同一渠道（PAYPAL）只能存在一条 payment_order；失败也只能重试同一条。

        - **并发闸门**：必须锁定 orders 行，确保同一订单同一时刻只有一个待支付支付单。

        - **同事务（同库）**：payment_order 的创建/状态推进 与 orders 的冗余字段/状态推进必须同事务完成。


        ### 推荐实现步骤（同库/同服务）

        1) `SELECT orders ... FOR UPDATE` 锁单

        2) 校验订单可支付（未 PAID、未超时、未进入不可支付状态）

        3) 关闭该订单下所有 `payment_order.status IN (INIT,PENDING)`（换渠道场景）

        4) 创建/复用 payment_order（channel=PAYPAL，利用 `uk_order_id_channel(order_id,
        channel)`）

        5) 推进 orders：
           - `status: CREATED -> PENDING_PAYMENT`（若已是 PENDING_PAYMENT 可保持）
           - `pay_channel=PAYPAL, pay_status=INIT, payment_external_id=NULL`
        6) 事务外调用 PayPal Orders API，获取 PayPal Order ID

        7) 回填 `payment_order.external_id`，并更新 `orders.payment_external_id`


        > 注意：如果第 6 步失败，不应回滚前面事务结果；允许客户端重试（幂等复用同一 payment_order 再次创建 PayPal
        Order）。
      tags:
        - payment/Payments
        - Payments
      parameters:
        - name: csrf_token
          in: cookie
          description: ''
          required: true
          example: ec562f27-410f-4c67-9272-7905c5607172
          schema:
            type: string
        - name: access_token
          in: cookie
          description: ''
          required: true
          example: >-
            eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxIiwidWlkIjoxLCJhdWQiOiJ3ZWIiLCJuYmYiOjE3NjY4OTg3MTYsInJvbGVzIjoiVVNFUiIsImlzcyI6InNob3BwaW5nLmludGVybmF0aW9uYWwiLCJ0eXAiOiJhY2Nlc3MiLCJleHAiOjE3ODI0NTA3MTYsImlhdCI6MTc2Njg5ODcxNiwiZW1haWwiOiJsZWlsYTk0Njg1NTVAZ21haWwuY29tIiwidXNlcm5hbWUiOiJsZWlsYS11c2VyXzAxIn0.saKZnZfE9pPS7r3BCzwspIBUXk00-p-CebwCDtrDvHs
          schema:
            type: string
        - name: X-CSRF-Token
          in: header
          description: 双提交 CSRF 头。必须与 Cookie `csrf_token` 等值
          required: true
          example: ec562f27-410f-4c67-9272-7905c5607172
          schema:
            type: string
            maxLength: 64
        - name: Idempotency-Key
          in: header
          description: 幂等键（同一用户相同键请求只创建一次订单）
          required: false
          example: 4a6b0b1f-1d20-4fd4-8c37-9d36c9b36a88
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PayPalCheckoutCreateRequest'
            example:
              order_no: 06E88YV6KMM0ZHZ1GAGJW01HJW
              channel: PAYPAL
              local: es-ES
              return_url: https://shopping.example.com/pay/return
              cancel_url: https://shopping.example.com/pay/cancel
        required: true
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                type: object
                x-apifox-refs:
                  01KFFKJTAX9P7J0M8R98W04MD1:
                    $ref: '#/components/schemas/Result'
                    x-apifox-overrides:
                      data:
                        description: 业务数据（随具体接口定义）
                        $ref: '#/components/schemas/PayPalCheckoutRespond'
                    required: []
                x-apifox-orders:
                  - 01KFFKJTAX9P7J0M8R98W04MD1
                properties:
                  success:
                    type: boolean
                    description: 业务是否成功（非 HTTP 含义）
                    examples:
                      - true
                  code:
                    type: string
                    description: 业务码
                    examples:
                      - OK
                    enum:
                      - OK
                      - CREATED
                      - ACCEPTED
                      - FOUND
                      - BAD_REQUEST
                      - UNAUTHORIZED
                      - FORBIDDEN
                      - NOT_FOUND
                      - CONFLICT
                      - UNPROCESSABLE_ENTITY
                      - TOO_MANY_REQUESTS
                      - INTERNAL_SERVER_ERROR
                    x-apifox-enum:
                      - value: OK
                        name: OK
                        description: 成功
                      - value: CREATED
                        name: Created
                        description: 已创建
                      - value: ACCEPTED
                        name: Accepted
                        description: 已接受
                      - value: FOUND
                        name: Found / Redirect
                        description: 重定向
                      - value: BAD_REQUEST
                        name: Bad Request
                        description: 参数错误
                      - value: UNAUTHORIZED
                        name: Unauthorized
                        description: 未授权
                      - value: FORBIDDEN
                        name: Forbidden
                        description: 没有权限
                      - value: NOT_FOUND
                        name: Not Found
                        description: 未找到
                      - value: CONFLICT
                        name: Conflict
                        description: 冲突
                      - value: UNPROCESSABLE_ENTITY
                        name: Unprocessable Entity
                        description: 不能处理的实体
                      - value: TOO_MANY_REQUESTS
                        name: Too Many Requests
                        description: 请求过多
                      - value: INTERNAL_SERVER_ERROR
                        name: Internal Server Error
                        description: 服务器内部错误
                  message:
                    type: string
                    description: 人类可读的简短信息
                    examples:
                      - OK
                  timestamp:
                    type: string
                    format: date-time
                    description: 服务器时间
                    examples:
                      - '2025-10-26T06:30:00.123Z'
                  traceId:
                    type:
                      - string
                      - 'null'
                    description: 请求追踪ID
                    examples:
                      - af9c5b1f0e2a4c1b
                  data:
                    description: 业务数据（随具体接口定义）
                    $ref: '#/components/schemas/PayPalCheckoutRespond'
                  meta:
                    description: 附加元信息（分页等，可选）
                    type:
                      - object
                      - 'null'
                    properties:
                      page:
                        type: integer
                        examples:
                          - 1
                      size:
                        type: integer
                        examples:
                          - 20
                      total:
                        type: integer
                        examples:
                          - 135
                    x-apifox-orders:
                      - page
                      - size
                      - total
                    x-apifox-ignore-properties: []
                required:
                  - success
                  - code
                  - message
                  - timestamp
                x-apifox-ignore-properties:
                  - success
                  - code
                  - message
                  - timestamp
                  - traceId
                  - data
                  - meta
              example:
                success: true
                code: CREATED
                message: Created
                timestamp: '2026-01-20T14:30:00+08:00'
                data:
                  payment_id: 90001
                  order_no: 01JAZ9H1E9E3YQ9Y8KQ8X7W3QZ
                  channel: PAYPAL
                  amount: 12999
                  currency: USD
                  status: PENDING
                  paypal_order_id: 6KD12345AB6789012
                  approve_url: https://www.paypal.com/checkoutnow?token=6KD12345AB6789012
          headers: {}
          x-apifox-name: 已创建
          x-apifox-ordering: 0
        '400':
          $ref: '#/components/responses/参数错误'
          description: ''
          x-apifox-ordering: 1
        '401':
          $ref: '#/components/responses/未鉴权'
          description: ''
          x-apifox-ordering: 2
        '403':
          $ref: '#/components/responses/权限不足'
          description: ''
          x-apifox-ordering: 3
        '404':
          $ref: '#/components/responses/未找到'
          description: ''
          x-apifox-ordering: 4
        '409':
          $ref: '#/components/responses/冲突'
          description: ''
          x-apifox-ordering: 5
        '429':
          $ref: '#/components/responses/请求过多'
          description: ''
          x-apifox-ordering: 6
      security: []
      x-apifox-folder: payment/Payments
      x-apifox-status: released
      x-run-in-apifox: https://app.apifox.com/web/project/7302473/apis/api-408258407-run
  /payments/paypal/{payment_id}/capture:
    post:
      summary: Capture PayPal 支付（回跳后确认扣款）
      deprecated: false
      description: |
        ### 目的
        前端在用户从 PayPal 回跳后调用：对 PayPal Order 执行 capture，完成扣款确认。

        ### 晚到支付规则（以 capture 时间为准）
        - 以 `capture_time` 判断：
          - 若 `capture_time <= orders.created_at + TTL`：进入“支付成功分支”
          - 否则：直接 `EXCEPTION + 自动退款`
        - 支付成功分支下：
          - 若订单已 CLOSED/CANCELLED 且库存已释放，并且当前库存不足/不可履约：`EXCEPTION + 自动退款`
          - 否则：推进为支付成功并继续履约（orders.status->PAID 等）

        ### 并发与事务
        - 建议锁定 orders 行（或严格 CAS）避免与关闭/取消并发冲突
        - 同事务内（同库）：
          - payment_order.status -> SUCCESS/FAIL/EXCEPTION（CAS）
          - 回写 orders 的 pay_status/pay_time/payment_external_id 以及 orders.status（PAID/EXCEPTION 等）

        ### 幂等
        - 重复 capture 必须幂等：已 SUCCESS 直接返回 SUCCESS
      tags:
        - payment/Payments
        - Payments
      parameters:
        - name: access_token
          in: cookie
          description: 会话访问令牌（HttpOnly Cookie）
          required: true
          example: ''
          schema:
            type: string
        - name: csrf_token
          in: cookie
          description: CSRF Cookie（双提交）
          required: true
          example: ''
          schema:
            type: string
        - name: payment_id
          in: path
          description: 对应 payment_order.id
          required: true
          example: 0
          schema:
            type: integer
            format: int64
        - name: Idempotency-Key
          in: header
          description: 幂等键（可选；对重复点击/重试友好）
          required: false
          example: ''
          schema:
            type: string
            maxLength: 64
        - name: X-CSRF-Token
          in: header
          description: CSRF Header（必须与 Cookie csrf_token 相等）
          required: true
          example: ''
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PayPalCaptureRequest'
            examples: {}
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                x-apifox-refs:
                  01KFFKTDS9AV34VXNC2NFS5T7N:
                    $ref: '#/components/schemas/Result'
                    x-apifox-overrides:
                      data:
                        description: 业务数据（随具体接口定义）
                        $ref: '#/components/schemas/PaymentResultRespond'
                    required: []
                x-apifox-orders:
                  - 01KFFKTDS9AV34VXNC2NFS5T7N
                properties:
                  success:
                    type: boolean
                    description: 业务是否成功（非 HTTP 含义）
                    examples:
                      - true
                  code:
                    type: string
                    description: 业务码
                    examples:
                      - OK
                    enum:
                      - OK
                      - CREATED
                      - ACCEPTED
                      - FOUND
                      - BAD_REQUEST
                      - UNAUTHORIZED
                      - FORBIDDEN
                      - NOT_FOUND
                      - CONFLICT
                      - UNPROCESSABLE_ENTITY
                      - TOO_MANY_REQUESTS
                      - INTERNAL_SERVER_ERROR
                    x-apifox-enum:
                      - value: OK
                        name: OK
                        description: 成功
                      - value: CREATED
                        name: Created
                        description: 已创建
                      - value: ACCEPTED
                        name: Accepted
                        description: 已接受
                      - value: FOUND
                        name: Found / Redirect
                        description: 重定向
                      - value: BAD_REQUEST
                        name: Bad Request
                        description: 参数错误
                      - value: UNAUTHORIZED
                        name: Unauthorized
                        description: 未授权
                      - value: FORBIDDEN
                        name: Forbidden
                        description: 没有权限
                      - value: NOT_FOUND
                        name: Not Found
                        description: 未找到
                      - value: CONFLICT
                        name: Conflict
                        description: 冲突
                      - value: UNPROCESSABLE_ENTITY
                        name: Unprocessable Entity
                        description: 不能处理的实体
                      - value: TOO_MANY_REQUESTS
                        name: Too Many Requests
                        description: 请求过多
                      - value: INTERNAL_SERVER_ERROR
                        name: Internal Server Error
                        description: 服务器内部错误
                  message:
                    type: string
                    description: 人类可读的简短信息
                    examples:
                      - OK
                  timestamp:
                    type: string
                    format: date-time
                    description: 服务器时间
                    examples:
                      - '2025-10-26T06:30:00.123Z'
                  traceId:
                    type:
                      - string
                      - 'null'
                    description: 请求追踪ID
                    examples:
                      - af9c5b1f0e2a4c1b
                  data:
                    description: 业务数据（随具体接口定义）
                    $ref: '#/components/schemas/PaymentResultRespond'
                  meta:
                    description: 附加元信息（分页等，可选）
                    type:
                      - object
                      - 'null'
                    properties:
                      page:
                        type: integer
                        examples:
                          - 1
                      size:
                        type: integer
                        examples:
                          - 20
                      total:
                        type: integer
                        examples:
                          - 135
                    x-apifox-orders:
                      - page
                      - size
                      - total
                    x-apifox-ignore-properties: []
                required:
                  - success
                  - code
                  - message
                  - timestamp
                x-apifox-ignore-properties:
                  - success
                  - code
                  - message
                  - timestamp
                  - traceId
                  - data
                  - meta
              example:
                success: true
                code: OK
                message: OK
                timestamp: '2026-01-20T14:30:00+08:00'
                data:
                  payment_id: 90001
                  status: SUCCESS
                  external_id: 6KD12345AB6789012
                  order_no: 01JAZ9H1E9E3YQ9Y8KQ8X7W3QZ
                  message: capture success
          headers: {}
          x-apifox-name: 成功
          x-apifox-ordering: 0
        '400':
          $ref: '#/components/responses/参数错误'
          description: ''
          x-apifox-ordering: 1
        '401':
          $ref: '#/components/responses/未鉴权'
          description: ''
          x-apifox-ordering: 2
        '403':
          $ref: '#/components/responses/权限不足'
          description: ''
          x-apifox-ordering: 3
        '404':
          $ref: '#/components/responses/未找到'
          description: ''
          x-apifox-ordering: 4
        '409':
          $ref: '#/components/responses/冲突'
          description: ''
          x-apifox-ordering: 5
        '429':
          $ref: '#/components/responses/请求过多'
          description: ''
          x-apifox-ordering: 6
      security: []
      x-apifox-folder: payment/Payments
      x-apifox-status: released
      x-run-in-apifox: https://app.apifox.com/web/project/7302473/apis/api-408258408-run
  /payments/paypal/{payment_id}/cancel:
    post:
      summary: 取消本次支付尝试（关闭支付单，不等于关闭订单）
      deprecated: false
      description: >
        - 同事务内：
          - payment_order.status INIT/PENDING -> CLOSED（CAS）
          - 回写 orders.pay_status -> CLOSED（冗余同步）
        - 不负责关闭订单；订单关闭入口收口在 Orders
        域，本接口只用于承接用户在支付网关的页面中点击取消时的回调，取消本次支付，但用户仍可支付原订单
      tags:
        - payment/Payments
        - Payments
      parameters:
        - name: access_token
          in: cookie
          description: 会话访问令牌（HttpOnly Cookie）
          required: true
          example: ''
          schema:
            type: string
        - name: csrf_token
          in: cookie
          description: CSRF Cookie（双提交）
          required: true
          example: ''
          schema:
            type: string
        - name: payment_id
          in: path
          description: payment_order.id
          required: true
          example: 0
          schema:
            type: integer
            format: int64
        - name: Idempotency-Key
          in: header
          description: 幂等键（可选；对重复点击/重试友好）
          required: false
          example: ''
          schema:
            type: string
            maxLength: 64
        - name: X-CSRF-Token
          in: header
          description: CSRF Header（必须与 Cookie csrf_token 相等）
          required: true
          example: ''
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                x-apifox-refs:
                  01KFFKWTFW3YTAQW38XEDHPQ2T:
                    $ref: '#/components/schemas/Result'
                    x-apifox-overrides:
                      data:
                        description: 业务数据（随具体接口定义）
                        $ref: '#/components/schemas/PaymentResultRespond'
                    required: []
                x-apifox-orders:
                  - 01KFFKWTFW3YTAQW38XEDHPQ2T
                properties:
                  success:
                    type: boolean
                    description: 业务是否成功（非 HTTP 含义）
                    examples:
                      - true
                  code:
                    type: string
                    description: 业务码
                    examples:
                      - OK
                    enum:
                      - OK
                      - CREATED
                      - ACCEPTED
                      - FOUND
                      - BAD_REQUEST
                      - UNAUTHORIZED
                      - FORBIDDEN
                      - NOT_FOUND
                      - CONFLICT
                      - UNPROCESSABLE_ENTITY
                      - TOO_MANY_REQUESTS
                      - INTERNAL_SERVER_ERROR
                    x-apifox-enum:
                      - value: OK
                        name: OK
                        description: 成功
                      - value: CREATED
                        name: Created
                        description: 已创建
                      - value: ACCEPTED
                        name: Accepted
                        description: 已接受
                      - value: FOUND
                        name: Found / Redirect
                        description: 重定向
                      - value: BAD_REQUEST
                        name: Bad Request
                        description: 参数错误
                      - value: UNAUTHORIZED
                        name: Unauthorized
                        description: 未授权
                      - value: FORBIDDEN
                        name: Forbidden
                        description: 没有权限
                      - value: NOT_FOUND
                        name: Not Found
                        description: 未找到
                      - value: CONFLICT
                        name: Conflict
                        description: 冲突
                      - value: UNPROCESSABLE_ENTITY
                        name: Unprocessable Entity
                        description: 不能处理的实体
                      - value: TOO_MANY_REQUESTS
                        name: Too Many Requests
                        description: 请求过多
                      - value: INTERNAL_SERVER_ERROR
                        name: Internal Server Error
                        description: 服务器内部错误
                  message:
                    type: string
                    description: 人类可读的简短信息
                    examples:
                      - OK
                  timestamp:
                    type: string
                    format: date-time
                    description: 服务器时间
                    examples:
                      - '2025-10-26T06:30:00.123Z'
                  traceId:
                    type:
                      - string
                      - 'null'
                    description: 请求追踪ID
                    examples:
                      - af9c5b1f0e2a4c1b
                  data:
                    description: 业务数据（随具体接口定义）
                    $ref: '#/components/schemas/PaymentResultRespond'
                  meta:
                    description: 附加元信息（分页等，可选）
                    type:
                      - object
                      - 'null'
                    properties:
                      page:
                        type: integer
                        examples:
                          - 1
                      size:
                        type: integer
                        examples:
                          - 20
                      total:
                        type: integer
                        examples:
                          - 135
                    x-apifox-orders:
                      - page
                      - size
                      - total
                    x-apifox-ignore-properties: []
                required:
                  - success
                  - code
                  - message
                  - timestamp
                x-apifox-ignore-properties:
                  - success
                  - code
                  - message
                  - timestamp
                  - traceId
                  - data
                  - meta
              example:
                success: true
                code: OK
                message: OK
                timestamp: '2026-01-20T14:30:00+08:00'
                data:
                  payment_id: 90001
                  status: SUCCESS
                  external_id: 6KD12345AB6789012
                  order_no: 01JAZ9H1E9E3YQ9Y8KQ8X7W3QZ
                  message: capture success
          headers: {}
          x-apifox-name: 成功
          x-apifox-ordering: 0
        '400':
          $ref: '#/components/responses/参数错误'
          description: ''
          x-apifox-ordering: 1
        '401':
          $ref: '#/components/responses/未鉴权'
          description: ''
          x-apifox-ordering: 2
        '403':
          $ref: '#/components/responses/权限不足'
          description: ''
          x-apifox-ordering: 3
        '404':
          $ref: '#/components/responses/未找到'
          description: ''
          x-apifox-ordering: 4
        '409':
          $ref: '#/components/responses/冲突'
          description: ''
          x-apifox-ordering: 5
      security: []
      x-apifox-folder: payment/Payments
      x-apifox-status: released
      x-run-in-apifox: https://app.apifox.com/web/project/7302473/apis/api-408258409-run
  /webhooks/paypal:
    post:
      summary: PayPal Webhook 回调入口（匿名）
      deprecated: false
      description: |
        - 必须验签、防重放
        - 必须幂等
        - 同事务（同库）内更新 payment_order 并回写 orders 状态
        - 晚到支付规则同 capture：以 capture_time 判定是否在 TTL 内
      tags:
        - payment/PayPalWebhook
        - PayPalWebhook
      parameters: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PayPalWebhookEvent'
            example:
              id: '49'
              create_time: '2013-06-25T21:41:28Z'
              event_version: nostrud ad Excepteur exercitation
              event_type: fugiat commodo
              summary: ullamco minim sed
              resource_version: dolor consectetur labore elit nostrud
              resource: {}
              links:
                - href: magna officia in labore
                  rel: dolor eiusmod
                  method: qui nostrud nulla nisi quis
                - href: magna officia in labore
                  rel: dolor eiusmod
                  method: qui nostrud nulla nisi quis
                - href: magna officia in labore
                  rel: dolor eiusmod
                  method: qui nostrud nulla nisi quis
        required: true
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Result'
              example:
                success: true
                code: OK
                message: OK
                timestamp: '2026-01-20T14:30:00+08:00'
                data: null
          headers: {}
          x-apifox-name: 成功
          x-apifox-ordering: 0
        '400':
          $ref: '#/components/responses/参数错误'
          description: ''
          x-apifox-ordering: 1
      security: []
      x-apifox-folder: payment/PayPalWebhook
      x-apifox-status: released
      x-run-in-apifox: https://app.apifox.com/web/project/7302473/apis/api-408258410-run
  /admin/payments/{payment_id}/sync:
    post:
      summary: 运维/排障：强制查询 PayPal 刷新支付状态
      deprecated: false
      description: |
        - 用于排障/对账/补偿，不作为日常业务入口
        - 查询 PayPal -> 同事务内（刷新 payment_order -> 回写 orders）
      tags:
        - payment/OpsSync
        - OpsSync
      parameters:
        - name: access_token
          in: cookie
          description: 会话访问令牌（HttpOnly Cookie）
          required: true
          example: ''
          schema:
            type: string
        - name: csrf_token
          in: cookie
          description: CSRF Cookie（双提交）
          required: true
          example: ''
          schema:
            type: string
        - name: payment_id
          in: path
          description: ''
          required: true
          example: 0
          schema:
            type: integer
            format: int64
        - name: X-CSRF-Token
          in: header
          description: CSRF Header（必须与 Cookie csrf_token 相等）
          required: true
          example: ''
          schema:
            type: string
      responses:
        '202':
          description: 已受理（异步处理/任务执行）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Result'
              example:
                success: true
                code: ACCEPTED
                message: Accepted
                timestamp: '2026-01-20T14:30:00+08:00'
                data: null
          headers: {}
          x-apifox-name: 已接受
          x-apifox-ordering: 0
        '400':
          $ref: '#/components/responses/参数错误'
          description: ''
          x-apifox-ordering: 1
        '401':
          $ref: '#/components/responses/未鉴权'
          description: ''
          x-apifox-ordering: 2
        '403':
          $ref: '#/components/responses/权限不足'
          description: ''
          x-apifox-ordering: 3
        '404':
          $ref: '#/components/responses/未找到'
          description: ''
          x-apifox-ordering: 4
      security: []
      x-apifox-folder: payment/OpsSync
      x-apifox-status: released
      x-run-in-apifox: https://app.apifox.com/web/project/7302473/apis/api-408258411-run
  /admin/payments:
    get:
      summary: 管理侧分页查询支付单
      deprecated: false
      description: |
        - 仅用于管理后台/排障/对账（不对用户侧开放）
        - 支持按订单号、外部单号、状态、时间范围筛选
        - 返回列表为轻量字段；详细 payload 请用详情接口
      tags:
        - payment/AdminPayments
        - AdminPayments
      parameters:
        - name: access_token
          in: cookie
          description: 会话访问令牌（HttpOnly Cookie）
          required: true
          example: ''
          schema:
            type: string
        - name: csrf_token
          in: cookie
          description: CSRF Cookie（双提交）
          required: true
          example: ''
          schema:
            type: string
        - name: order_no
          in: query
          description: 按订单号筛选（建议内部联表查询 orders.id）
          required: false
          schema:
            type: string
        - name: external_id
          in: query
          description: PayPal Order ID
          required: false
          schema:
            type: string
        - name: channel
          in: query
          description: ''
          required: false
          schema:
            type: string
            enum:
              - NONE
              - ALIPAY
              - WECHAT
              - STRIPE
              - PAYPAL
              - OTHER
            x-apifox-enum:
              - value: NONE
                name: ''
                description: ''
              - value: ALIPAY
                name: ''
                description: ''
              - value: WECHAT
                name: ''
                description: ''
              - value: STRIPE
                name: ''
                description: ''
              - value: PAYPAL
                name: ''
                description: ''
              - value: OTHER
                name: ''
                description: ''
        - name: status
          in: query
          description: ''
          required: false
          schema:
            type: string
            enum:
              - NONE
              - INIT
              - PENDING
              - SUCCESS
              - FAIL
              - CLOSED
              - EXCEPTION
            x-apifox-enum:
              - value: NONE
                name: ''
                description: ''
              - value: INIT
                name: ''
                description: ''
              - value: PENDING
                name: ''
                description: ''
              - value: SUCCESS
                name: ''
                description: ''
              - value: FAIL
                name: ''
                description: ''
              - value: CLOSED
                name: ''
                description: ''
              - value: EXCEPTION
                name: ''
                description: ''
        - name: created_from
          in: query
          description: ''
          required: false
          schema:
            type: string
            format: date-time
        - name: created_to
          in: query
          description: ''
          required: false
          schema:
            type: string
            format: date-time
        - name: page
          in: query
          description: ''
          required: false
          schema:
            type: integer
            default: 1
            minimum: 1
        - name: size
          in: query
          description: ''
          required: false
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 200
        - name: sort
          in: query
          description: 排序字段与方向（示例：created_at,desc / updated_at,desc）
          required: false
          schema:
            type: string
            default: created_at,desc
        - name: X-CSRF-Token
          in: header
          description: CSRF Header（必须与 Cookie csrf_token 相等）
          required: true
          example: ''
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                x-apifox-refs:
                  01KFFMT3YQ91Y1D4SJ1QB2S76P:
                    $ref: '#/components/schemas/Result'
                    x-apifox-overrides:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/PaymentListItem'
                        description: 业务数据（随具体接口定义）
                    required: []
                x-apifox-orders:
                  - 01KFFMT3YQ91Y1D4SJ1QB2S76P
                properties:
                  success:
                    type: boolean
                    description: 业务是否成功（非 HTTP 含义）
                    examples:
                      - true
                  code:
                    type: string
                    description: 业务码
                    examples:
                      - OK
                    enum:
                      - OK
                      - CREATED
                      - ACCEPTED
                      - FOUND
                      - BAD_REQUEST
                      - UNAUTHORIZED
                      - FORBIDDEN
                      - NOT_FOUND
                      - CONFLICT
                      - UNPROCESSABLE_ENTITY
                      - TOO_MANY_REQUESTS
                      - INTERNAL_SERVER_ERROR
                    x-apifox-enum:
                      - value: OK
                        name: OK
                        description: 成功
                      - value: CREATED
                        name: Created
                        description: 已创建
                      - value: ACCEPTED
                        name: Accepted
                        description: 已接受
                      - value: FOUND
                        name: Found / Redirect
                        description: 重定向
                      - value: BAD_REQUEST
                        name: Bad Request
                        description: 参数错误
                      - value: UNAUTHORIZED
                        name: Unauthorized
                        description: 未授权
                      - value: FORBIDDEN
                        name: Forbidden
                        description: 没有权限
                      - value: NOT_FOUND
                        name: Not Found
                        description: 未找到
                      - value: CONFLICT
                        name: Conflict
                        description: 冲突
                      - value: UNPROCESSABLE_ENTITY
                        name: Unprocessable Entity
                        description: 不能处理的实体
                      - value: TOO_MANY_REQUESTS
                        name: Too Many Requests
                        description: 请求过多
                      - value: INTERNAL_SERVER_ERROR
                        name: Internal Server Error
                        description: 服务器内部错误
                  message:
                    type: string
                    description: 人类可读的简短信息
                    examples:
                      - OK
                  timestamp:
                    type: string
                    format: date-time
                    description: 服务器时间
                    examples:
                      - '2025-10-26T06:30:00.123Z'
                  traceId:
                    type:
                      - string
                      - 'null'
                    description: 请求追踪ID
                    examples:
                      - af9c5b1f0e2a4c1b
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/PaymentListItem'
                    description: 业务数据（随具体接口定义）
                  meta:
                    description: 附加元信息（分页等，可选）
                    type:
                      - object
                      - 'null'
                    properties:
                      page:
                        type: integer
                        examples:
                          - 1
                      size:
                        type: integer
                        examples:
                          - 20
                      total:
                        type: integer
                        examples:
                          - 135
                    x-apifox-orders:
                      - page
                      - size
                      - total
                    x-apifox-ignore-properties: []
                required:
                  - success
                  - code
                  - message
                  - timestamp
                x-apifox-ignore-properties:
                  - success
                  - code
                  - message
                  - timestamp
                  - traceId
                  - data
                  - meta
              example:
                success: true
                code: OK
                message: OK
                timestamp: '2026-01-20T14:30:00+08:00'
                data:
                  items:
                    - payment_id: 90001
                      order_id: 10001
                      order_no: 01JAZ9H1E9E3YQ9Y8KQ8X7W3QZ
                      external_id: 6KD12345AB6789012
                      channel: PAYPAL
                      status: PENDING
                      amount: 12999
                      currency: USD
                      last_polled_at: null
                      last_notified_at: null
                      created_at: '2026-01-20T14:05:12+08:00'
                      updated_at: '2026-01-20T14:05:18+08:00'
                  page:
                    page: 1
                    size: 20
                    total: 1
          headers: {}
          x-apifox-name: 成功
          x-apifox-ordering: 0
        '400':
          $ref: '#/components/responses/参数错误'
          description: ''
          x-apifox-ordering: 1
        '401':
          $ref: '#/components/responses/未鉴权'
          description: ''
          x-apifox-ordering: 2
        '403':
          $ref: '#/components/responses/权限不足'
          description: ''
          x-apifox-ordering: 3
      security: []
      x-apifox-folder: payment/AdminPayments
      x-apifox-status: released
      x-run-in-apifox: https://app.apifox.com/web/project/7302473/apis/api-408258412-run
  /admin/payments/{payment_id}:
    get:
      summary: 管理侧查询支付单详细信息
      deprecated: false
      description: |
        - 返回支付单的完整信息（含 request/response/notify payload）
        - 可用于排障、对账、审计
      tags:
        - payment/AdminPayments
        - AdminPayments
      parameters:
        - name: access_token
          in: cookie
          description: 会话访问令牌（HttpOnly Cookie）
          required: true
          example: ''
          schema:
            type: string
        - name: csrf_token
          in: cookie
          description: CSRF Cookie（双提交）
          required: true
          example: ''
          schema:
            type: string
        - name: payment_id
          in: path
          description: ''
          required: true
          example: 0
          schema:
            type: integer
            format: int64
        - name: X-CSRF-Token
          in: header
          description: CSRF Header（必须与 Cookie csrf_token 相等）
          required: true
          example: ''
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                x-apifox-refs:
                  01KFFMZBTQMSJM6P8TKHDF01WA:
                    $ref: '#/components/schemas/Result'
                    x-apifox-overrides:
                      data:
                        description: 业务数据（随具体接口定义）
                        $ref: '#/components/schemas/PaymentDetail'
                    required: []
                x-apifox-orders:
                  - 01KFFMZBTQMSJM6P8TKHDF01WA
                properties:
                  success:
                    type: boolean
                    description: 业务是否成功（非 HTTP 含义）
                    examples:
                      - true
                  code:
                    type: string
                    description: 业务码
                    examples:
                      - OK
                    enum:
                      - OK
                      - CREATED
                      - ACCEPTED
                      - FOUND
                      - BAD_REQUEST
                      - UNAUTHORIZED
                      - FORBIDDEN
                      - NOT_FOUND
                      - CONFLICT
                      - UNPROCESSABLE_ENTITY
                      - TOO_MANY_REQUESTS
                      - INTERNAL_SERVER_ERROR
                    x-apifox-enum:
                      - value: OK
                        name: OK
                        description: 成功
                      - value: CREATED
                        name: Created
                        description: 已创建
                      - value: ACCEPTED
                        name: Accepted
                        description: 已接受
                      - value: FOUND
                        name: Found / Redirect
                        description: 重定向
                      - value: BAD_REQUEST
                        name: Bad Request
                        description: 参数错误
                      - value: UNAUTHORIZED
                        name: Unauthorized
                        description: 未授权
                      - value: FORBIDDEN
                        name: Forbidden
                        description: 没有权限
                      - value: NOT_FOUND
                        name: Not Found
                        description: 未找到
                      - value: CONFLICT
                        name: Conflict
                        description: 冲突
                      - value: UNPROCESSABLE_ENTITY
                        name: Unprocessable Entity
                        description: 不能处理的实体
                      - value: TOO_MANY_REQUESTS
                        name: Too Many Requests
                        description: 请求过多
                      - value: INTERNAL_SERVER_ERROR
                        name: Internal Server Error
                        description: 服务器内部错误
                  message:
                    type: string
                    description: 人类可读的简短信息
                    examples:
                      - OK
                  timestamp:
                    type: string
                    format: date-time
                    description: 服务器时间
                    examples:
                      - '2025-10-26T06:30:00.123Z'
                  traceId:
                    type:
                      - string
                      - 'null'
                    description: 请求追踪ID
                    examples:
                      - af9c5b1f0e2a4c1b
                  data:
                    description: 业务数据（随具体接口定义）
                    $ref: '#/components/schemas/PaymentDetail'
                  meta:
                    description: 附加元信息（分页等，可选）
                    type:
                      - object
                      - 'null'
                    properties:
                      page:
                        type: integer
                        examples:
                          - 1
                      size:
                        type: integer
                        examples:
                          - 20
                      total:
                        type: integer
                        examples:
                          - 135
                    x-apifox-orders:
                      - page
                      - size
                      - total
                    x-apifox-ignore-properties: []
                required:
                  - success
                  - code
                  - message
                  - timestamp
                x-apifox-ignore-properties:
                  - success
                  - code
                  - message
                  - timestamp
                  - traceId
                  - data
                  - meta
          headers: {}
          x-apifox-name: 成功
          x-apifox-ordering: 0
        '400':
          $ref: '#/components/responses/参数错误'
          description: ''
          x-apifox-ordering: 1
        '401':
          $ref: '#/components/responses/未鉴权'
          description: ''
          x-apifox-ordering: 2
        '403':
          $ref: '#/components/responses/权限不足'
          description: ''
          x-apifox-ordering: 3
        '404':
          $ref: '#/components/responses/未找到'
          description: ''
          x-apifox-ordering: 4
      security: []
      x-apifox-folder: payment/AdminPayments
      x-apifox-status: released
      x-run-in-apifox: https://app.apifox.com/web/project/7302473/apis/api-408258413-run
  /admin/refunds:
    get:
      summary: 管理侧分页查询退款单
      deprecated: false
      description: |
        - 仅用于管理后台/排障/对账（不对用户侧开放）
        - 退款创建入口收口在 Orders 域；Payment 域仅提供只读查询
        - 支持按订单号、外部退款单号、状态、时间范围筛选
      tags:
        - payment/AdminRefunds
        - AdminRefunds
      parameters:
        - name: access_token
          in: cookie
          description: 会话访问令牌（HttpOnly Cookie）
          required: true
          example: ''
          schema:
            type: string
        - name: csrf_token
          in: cookie
          description: CSRF Cookie（双提交）
          required: true
          example: ''
          schema:
            type: string
        - name: order_no
          in: query
          description: 按订单号筛选（建议内部联表查询 orders.id）
          required: false
          schema:
            type: string
        - name: external_id
          in: query
          description: PayPal Refund ID（或网关退款标识）
          required: false
          schema:
            type: string
        - name: channel
          in: query
          description: ''
          required: false
          schema:
            type: string
            enum:
              - NONE
              - ALIPAY
              - WECHAT
              - STRIPE
              - PAYPAL
              - OTHER
            x-apifox-enum:
              - value: NONE
                name: ''
                description: ''
              - value: ALIPAY
                name: ''
                description: ''
              - value: WECHAT
                name: ''
                description: ''
              - value: STRIPE
                name: ''
                description: ''
              - value: PAYPAL
                name: ''
                description: ''
              - value: OTHER
                name: ''
                description: ''
        - name: status
          in: query
          description: ''
          required: false
          schema:
            type: string
            enum:
              - NONE
              - INIT
              - PENDING
              - SUCCESS
              - FAIL
              - CLOSED
              - EXCEPTION
            x-apifox-enum:
              - value: NONE
                name: ''
                description: ''
              - value: INIT
                name: ''
                description: ''
              - value: PENDING
                name: ''
                description: ''
              - value: SUCCESS
                name: ''
                description: ''
              - value: FAIL
                name: ''
                description: ''
              - value: CLOSED
                name: ''
                description: ''
              - value: EXCEPTION
                name: ''
                description: ''
        - name: created_from
          in: query
          description: ''
          required: false
          schema:
            type: string
            format: date-time
        - name: created_to
          in: query
          description: ''
          required: false
          schema:
            type: string
            format: date-time
        - name: page
          in: query
          description: ''
          required: false
          schema:
            type: integer
            default: 1
            minimum: 1
        - name: size
          in: query
          description: ''
          required: false
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 200
        - name: sort
          in: query
          description: 排序字段与方向（示例：created_at,desc / updated_at,desc）
          required: false
          schema:
            type: string
            default: created_at,desc
        - name: X-CSRF-Token
          in: header
          description: CSRF Header（必须与 Cookie csrf_token 相等）
          required: true
          example: ''
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                x-apifox-refs:
                  01KFFN6AZH4MCCK48J8V49BRRN:
                    $ref: '#/components/schemas/Result'
                    x-apifox-overrides:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/RefundListItem'
                        description: 业务数据（随具体接口定义）
                    required: []
                x-apifox-orders:
                  - 01KFFN6AZH4MCCK48J8V49BRRN
                properties:
                  success:
                    type: boolean
                    description: 业务是否成功（非 HTTP 含义）
                    examples:
                      - true
                  code:
                    type: string
                    description: 业务码
                    examples:
                      - OK
                    enum:
                      - OK
                      - CREATED
                      - ACCEPTED
                      - FOUND
                      - BAD_REQUEST
                      - UNAUTHORIZED
                      - FORBIDDEN
                      - NOT_FOUND
                      - CONFLICT
                      - UNPROCESSABLE_ENTITY
                      - TOO_MANY_REQUESTS
                      - INTERNAL_SERVER_ERROR
                    x-apifox-enum:
                      - value: OK
                        name: OK
                        description: 成功
                      - value: CREATED
                        name: Created
                        description: 已创建
                      - value: ACCEPTED
                        name: Accepted
                        description: 已接受
                      - value: FOUND
                        name: Found / Redirect
                        description: 重定向
                      - value: BAD_REQUEST
                        name: Bad Request
                        description: 参数错误
                      - value: UNAUTHORIZED
                        name: Unauthorized
                        description: 未授权
                      - value: FORBIDDEN
                        name: Forbidden
                        description: 没有权限
                      - value: NOT_FOUND
                        name: Not Found
                        description: 未找到
                      - value: CONFLICT
                        name: Conflict
                        description: 冲突
                      - value: UNPROCESSABLE_ENTITY
                        name: Unprocessable Entity
                        description: 不能处理的实体
                      - value: TOO_MANY_REQUESTS
                        name: Too Many Requests
                        description: 请求过多
                      - value: INTERNAL_SERVER_ERROR
                        name: Internal Server Error
                        description: 服务器内部错误
                  message:
                    type: string
                    description: 人类可读的简短信息
                    examples:
                      - OK
                  timestamp:
                    type: string
                    format: date-time
                    description: 服务器时间
                    examples:
                      - '2025-10-26T06:30:00.123Z'
                  traceId:
                    type:
                      - string
                      - 'null'
                    description: 请求追踪ID
                    examples:
                      - af9c5b1f0e2a4c1b
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/RefundListItem'
                    description: 业务数据（随具体接口定义）
                  meta:
                    description: 附加元信息（分页等，可选）
                    type:
                      - object
                      - 'null'
                    properties:
                      page:
                        type: integer
                        examples:
                          - 1
                      size:
                        type: integer
                        examples:
                          - 20
                      total:
                        type: integer
                        examples:
                          - 135
                    x-apifox-orders:
                      - page
                      - size
                      - total
                    x-apifox-ignore-properties: []
                required:
                  - success
                  - code
                  - message
                  - timestamp
                x-apifox-ignore-properties:
                  - success
                  - code
                  - message
                  - timestamp
                  - traceId
                  - data
                  - meta
          headers: {}
          x-apifox-name: 成功
          x-apifox-ordering: 0
        '400':
          $ref: '#/components/responses/参数错误'
          description: ''
          x-apifox-ordering: 1
        '401':
          $ref: '#/components/responses/未鉴权'
          description: ''
          x-apifox-ordering: 2
        '403':
          $ref: '#/components/responses/权限不足'
          description: ''
          x-apifox-ordering: 3
      security: []
      x-apifox-folder: payment/AdminRefunds
      x-apifox-status: released
      x-run-in-apifox: https://app.apifox.com/web/project/7302473/apis/api-408258414-run
  /admin/refunds/{refund_id}:
    get:
      summary: 管理侧查询退款单详细信息
      deprecated: false
      description: |
        - 返回退款单的完整信息（含 request/response/notify payload）
        - 用于排障、对账、审计
      tags:
        - payment/AdminRefunds
        - AdminRefunds
      parameters:
        - name: access_token
          in: cookie
          description: 会话访问令牌（HttpOnly Cookie）
          required: true
          example: ''
          schema:
            type: string
        - name: csrf_token
          in: cookie
          description: CSRF Cookie（双提交）
          required: true
          example: ''
          schema:
            type: string
        - name: refund_id
          in: path
          description: ''
          required: true
          example: 0
          schema:
            type: integer
            format: int64
        - name: X-CSRF-Token
          in: header
          description: CSRF Header（必须与 Cookie csrf_token 相等）
          required: true
          example: ''
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                x-apifox-refs:
                  01KFFNG34ZEDKQYJ1E440WCGAF:
                    $ref: '#/components/schemas/Result'
                    x-apifox-overrides:
                      data:
                        description: 业务数据（随具体接口定义）
                        $ref: '#/components/schemas/AdminRefundDetail'
                    required: []
                x-apifox-orders:
                  - 01KFFNG34ZEDKQYJ1E440WCGAF
                properties:
                  success:
                    type: boolean
                    description: 业务是否成功（非 HTTP 含义）
                    examples:
                      - true
                  code:
                    type: string
                    description: 业务码
                    examples:
                      - OK
                    enum:
                      - OK
                      - CREATED
                      - ACCEPTED
                      - FOUND
                      - BAD_REQUEST
                      - UNAUTHORIZED
                      - FORBIDDEN
                      - NOT_FOUND
                      - CONFLICT
                      - UNPROCESSABLE_ENTITY
                      - TOO_MANY_REQUESTS
                      - INTERNAL_SERVER_ERROR
                    x-apifox-enum:
                      - value: OK
                        name: OK
                        description: 成功
                      - value: CREATED
                        name: Created
                        description: 已创建
                      - value: ACCEPTED
                        name: Accepted
                        description: 已接受
                      - value: FOUND
                        name: Found / Redirect
                        description: 重定向
                      - value: BAD_REQUEST
                        name: Bad Request
                        description: 参数错误
                      - value: UNAUTHORIZED
                        name: Unauthorized
                        description: 未授权
                      - value: FORBIDDEN
                        name: Forbidden
                        description: 没有权限
                      - value: NOT_FOUND
                        name: Not Found
                        description: 未找到
                      - value: CONFLICT
                        name: Conflict
                        description: 冲突
                      - value: UNPROCESSABLE_ENTITY
                        name: Unprocessable Entity
                        description: 不能处理的实体
                      - value: TOO_MANY_REQUESTS
                        name: Too Many Requests
                        description: 请求过多
                      - value: INTERNAL_SERVER_ERROR
                        name: Internal Server Error
                        description: 服务器内部错误
                  message:
                    type: string
                    description: 人类可读的简短信息
                    examples:
                      - OK
                  timestamp:
                    type: string
                    format: date-time
                    description: 服务器时间
                    examples:
                      - '2025-10-26T06:30:00.123Z'
                  traceId:
                    type:
                      - string
                      - 'null'
                    description: 请求追踪ID
                    examples:
                      - af9c5b1f0e2a4c1b
                  data:
                    description: 业务数据（随具体接口定义）
                    $ref: '#/components/schemas/AdminRefundDetail'
                  meta:
                    description: 附加元信息（分页等，可选）
                    type:
                      - object
                      - 'null'
                    properties:
                      page:
                        type: integer
                        examples:
                          - 1
                      size:
                        type: integer
                        examples:
                          - 20
                      total:
                        type: integer
                        examples:
                          - 135
                    x-apifox-orders:
                      - page
                      - size
                      - total
                    x-apifox-ignore-properties: []
                required:
                  - success
                  - code
                  - message
                  - timestamp
                x-apifox-ignore-properties:
                  - success
                  - code
                  - message
                  - timestamp
                  - traceId
                  - data
                  - meta
          headers: {}
          x-apifox-name: 成功
          x-apifox-ordering: 0
        '400':
          $ref: '#/components/responses/参数错误'
          description: ''
          x-apifox-ordering: 1
        '401':
          $ref: '#/components/responses/未鉴权'
          description: ''
          x-apifox-ordering: 2
        '403':
          $ref: '#/components/responses/权限不足'
          description: ''
          x-apifox-ordering: 3
        '404':
          $ref: '#/components/responses/未找到'
          description: ''
          x-apifox-ordering: 4
      security: []
      x-apifox-folder: payment/AdminRefunds
      x-apifox-status: released
      x-run-in-apifox: https://app.apifox.com/web/project/7302473/apis/api-408258415-run
webhooks: {}
components:
  schemas:
    Result:
      type: object
      required:
        - success
        - code
        - message
        - timestamp
      properties:
        success:
          type: boolean
          description: 业务是否成功（非 HTTP 含义）
          examples:
            - true
        code:
          type: string
          description: 业务码
          examples:
            - OK
          enum:
            - OK
            - CREATED
            - ACCEPTED
            - FOUND
            - BAD_REQUEST
            - UNAUTHORIZED
            - FORBIDDEN
            - NOT_FOUND
            - CONFLICT
            - UNPROCESSABLE_ENTITY
            - TOO_MANY_REQUESTS
            - INTERNAL_SERVER_ERROR
          x-apifox-enum:
            - value: OK
              name: OK
              description: 成功
            - value: CREATED
              name: Created
              description: 已创建
            - value: ACCEPTED
              name: Accepted
              description: 已接受
            - value: FOUND
              name: Found / Redirect
              description: 重定向
            - value: BAD_REQUEST
              name: Bad Request
              description: 参数错误
            - value: UNAUTHORIZED
              name: Unauthorized
              description: 未授权
            - value: FORBIDDEN
              name: Forbidden
              description: 没有权限
            - value: NOT_FOUND
              name: Not Found
              description: 未找到
            - value: CONFLICT
              name: Conflict
              description: 冲突
            - value: UNPROCESSABLE_ENTITY
              name: Unprocessable Entity
              description: 不能处理的实体
            - value: TOO_MANY_REQUESTS
              name: Too Many Requests
              description: 请求过多
            - value: INTERNAL_SERVER_ERROR
              name: Internal Server Error
              description: 服务器内部错误
        message:
          type: string
          description: 人类可读的简短信息
          examples:
            - OK
        timestamp:
          type: string
          format: date-time
          description: 服务器时间
          examples:
            - '2025-10-26T06:30:00.123Z'
        traceId:
          type:
            - string
            - 'null'
          description: 请求追踪ID
          examples:
            - af9c5b1f0e2a4c1b
        data:
          type: object
          properties: {}
          x-apifox-orders: []
          description: 业务数据（随具体接口定义）
          x-apifox-ignore-properties: []
        meta:
          description: 附加元信息（分页等，可选）
          type:
            - object
            - 'null'
          properties:
            page:
              type: integer
              examples:
                - 1
            size:
              type: integer
              examples:
                - 20
            total:
              type: integer
              examples:
                - 135
          x-apifox-orders:
            - page
            - size
            - total
          x-apifox-ignore-properties: []
      x-apifox-orders:
        - success
        - code
        - message
        - timestamp
        - traceId
        - data
        - meta
      x-apifox-ignore-properties: []
      x-apifox-folder: user
    PaymentChannel:
      type: string
      description: 支付通道（管理侧查询用，可扩展）
      enum:
        - NONE
        - ALIPAY
        - WECHAT
        - STRIPE
        - PAYPAL
        - OTHER
      x-apifox-enum:
        - value: NONE
          name: ''
          description: ''
        - value: ALIPAY
          name: ''
          description: ''
        - value: WECHAT
          name: ''
          description: ''
        - value: STRIPE
          name: ''
          description: ''
        - value: PAYPAL
          name: ''
          description: ''
        - value: OTHER
          name: ''
          description: ''
      x-apifox-folder: payment
    PaymentStatus:
      type: string
      description: 支付单状态（对应 payment_order.status）
      enum:
        - NONE
        - INIT
        - PENDING
        - SUCCESS
        - FAIL
        - CLOSED
        - EXCEPTION
      x-apifox-folder: payment
    RefundStatus:
      type: string
      description: 退款单状态（示例；与 payment_refund.status 对齐）
      enum:
        - INIT
        - PENDING
        - SUCCESS
        - FAIL
        - CLOSED
        - EXCEPTION
      x-apifox-folder: payment
    PayPalCheckoutCreateRequest:
      type: object
      required:
        - order_no
        - return_url
        - cancel_url
        - channel
        - local
      properties:
        order_no:
          type: string
          description: 业务订单号（orders.order_no）
          maxLength: 26
          minLength: 26
        channel:
          $ref: '#/components/schemas/PaymentChannel'
        local:
          type: string
        return_url:
          type: string
          description: 支付成功回跳地址（前端）
          maxLength: 500
        cancel_url:
          type: string
          description: 用户取消回跳地址（前端）
          maxLength: 500
      x-apifox-orders:
        - order_no
        - channel
        - local
        - return_url
        - cancel_url
      x-apifox-ignore-properties: []
      x-apifox-folder: payment
    PayPalCheckoutRespond:
      type: object
      required:
        - payment_id
        - order_no
        - channel
        - amount
        - currency
        - status
        - paypal_order_id
        - approve_url
      properties:
        payment_id:
          type: integer
          format: int64
          description: 支付单ID（payment_order.id）
        order_no:
          type: string
          description: 业务订单号
        channel:
          $ref: '#/components/schemas/PaymentChannel'
        amount:
          type: string
          description: 支付价格
        currency:
          type: string
          description: 币种代码
        status:
          $ref: '#/components/schemas/PaymentStatus'
        paypal_order_id:
          type: string
          description: PayPal Order ID（落在 payment_order.external_id）
        approve_url:
          type: string
          description: PayPal 跳转链接（前端跳转使用）
      x-apifox-orders:
        - payment_id
        - order_no
        - channel
        - amount
        - currency
        - status
        - paypal_order_id
        - approve_url
      x-apifox-ignore-properties: []
      x-apifox-folder: payment
    PayPalCaptureRequest:
      type: object
      properties:
        payer_id:
          type:
            - string
            - 'null'
          description: 可选：回跳携带的 payer_id（如有）
          maxLength: 128
        note:
          type:
            - string
            - 'null'
          description: 可选：备注
          maxLength: 500
      x-apifox-orders:
        - payer_id
        - note
      x-apifox-ignore-properties: []
      x-apifox-folder: payment
    PaymentResultRespond:
      type: object
      required:
        - payment_id
        - status
      properties:
        payment_id:
          type: integer
          format: int64
          description: 支付单ID（payment_order.id）
        status:
          $ref: '#/components/schemas/PaymentStatus'
        external_id:
          type:
            - string
            - 'null'
          description: PayPal Order ID
        order_no:
          type:
            - string
            - 'null'
          description: 业务订单号（可选回传）
        message:
          type:
            - string
            - 'null'
          description: 结果说明（可选）
      x-apifox-orders:
        - payment_id
        - status
        - external_id
        - order_no
        - message
      x-apifox-ignore-properties: []
      x-apifox-folder: payment
    PayPalWebhookEvent:
      type: object
      description: PayPal webhook 事件（保持宽松结构，便于兼容不同 event_type）
      additionalProperties: true
      x-apifox-orders:
        - id
        - create_time
        - event_version
        - event_type
        - summary
        - resource_version
        - resource
        - links
      properties:
        id:
          type: string
        create_time:
          type: string
          format: date-time
          examples:
            - '2013-06-25T21:41:28Z'
        event_version:
          type: string
        event_type:
          type: string
        summary:
          type: string
        resource_version:
          type: string
        resource:
          type: object
          properties: {}
          x-apifox-orders: []
          x-apifox-ignore-properties: []
        links:
          type: array
          items:
            type: object
            properties:
              href:
                type: string
              rel:
                type: string
              method:
                type: string
            x-apifox-orders:
              - href
              - rel
              - method
            required:
              - href
              - rel
              - method
            x-apifox-ignore-properties: []
      required:
        - id
        - create_time
        - event_version
        - event_type
        - summary
        - resource_version
        - resource
        - links
      x-apifox-ignore-properties: []
      x-apifox-folder: payment
    PaymentListItem:
      type: object
      required:
        - payment_id
        - order_id
        - channel
        - status
        - amount
        - currency
        - created_at
        - updated_at
        - order_no
      properties:
        payment_id:
          type: integer
          format: int64
          description: payment_order.id
        order_id:
          type: integer
          format: int64
          description: orders.id
        order_no:
          type: string
          description: 业务订单号（联表返回，便于后台展示）
        external_id:
          type:
            - string
            - 'null'
          description: PayPal Order ID
        channel:
          $ref: '#/components/schemas/PaymentChannel'
        status:
          $ref: '#/components/schemas/PaymentStatus'
        amount:
          type: string
          description: 支付单价格
        currency:
          type: string
          description: 币种
        last_polled_at:
          type:
            - string
            - 'null'
          format: date-time
        last_notified_at:
          type:
            - string
            - 'null'
          format: date-time
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
      x-apifox-orders:
        - payment_id
        - order_id
        - order_no
        - external_id
        - channel
        - status
        - amount
        - currency
        - last_polled_at
        - last_notified_at
        - created_at
        - updated_at
      x-apifox-ignore-properties: []
      x-apifox-folder: payment
    PaymentDetail:
      type: object
      required:
        - payment_id
        - order_id
        - channel
        - status
        - amount
        - currency
        - created_at
        - updated_at
        - order_no
      properties:
        payment_id:
          type: integer
          format: int64
        order_id:
          type: integer
          format: int64
        order_no:
          type: string
        external_id:
          type:
            - string
            - 'null'
        channel:
          $ref: '#/components/schemas/PaymentChannel'
        status:
          $ref: '#/components/schemas/PaymentStatus'
        amount:
          type: string
          description: 支付单价格
        currency:
          type: string
          description: 币种
        request_payload:
          type:
            - object
            - 'null'
          properties: {}
          x-apifox-orders: []
          additionalProperties: true
          x-apifox-ignore-properties: []
        response_payload:
          type:
            - object
            - 'null'
          properties: {}
          x-apifox-orders: []
          additionalProperties: true
          x-apifox-ignore-properties: []
        notify_payload:
          type:
            - object
            - 'null'
          properties: {}
          x-apifox-orders: []
          additionalProperties: true
          x-apifox-ignore-properties: []
        last_polled_at:
          type:
            - string
            - 'null'
          format: date-time
        last_notified_at:
          type:
            - string
            - 'null'
          format: date-time
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
      x-apifox-orders:
        - payment_id
        - order_id
        - order_no
        - external_id
        - channel
        - status
        - amount
        - currency
        - request_payload
        - response_payload
        - notify_payload
        - last_polled_at
        - last_notified_at
        - created_at
        - updated_at
      x-apifox-ignore-properties: []
      x-apifox-folder: payment
    RefundListItem:
      type: object
      required:
        - refund_id
        - order_id
        - channel
        - status
        - amount
        - currency
        - created_at
        - updated_at
        - refund_no
        - order_no
        - payment_id
      properties:
        refund_id:
          type: integer
          format: int64
          description: payment_refund.id
        refund_no:
          type: string
          description: 退款业务单号
        order_id:
          type: integer
          format: int64
        order_no:
          type: string
        payment_id:
          type: integer
          description: 关联 payment_order.id（如有）
          format: int64
        external_id:
          type:
            - string
            - 'null'
          description: PayPal Refund ID（或网关退款标识）
        channel:
          $ref: '#/components/schemas/PaymentChannel'
        status:
          $ref: '#/components/schemas/PaymentStatus'
        amount:
          type: string
          description: 退款单金额
        currency:
          type: string
          description: 币种
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
      x-apifox-orders:
        - refund_id
        - refund_no
        - order_id
        - order_no
        - payment_id
        - external_id
        - channel
        - status
        - amount
        - currency
        - created_at
        - updated_at
      x-apifox-ignore-properties: []
      x-apifox-folder: payment
    AdminRefundDetail:
      type: object
      required:
        - refund_id
        - order_id
        - channel
        - status
        - amount
        - currency
        - created_at
        - updated_at
        - refund_no
        - order_no
        - payment_id
      properties:
        refund_id:
          type: integer
          format: int64
        refund_no:
          type: string
        order_id:
          type: integer
          format: int64
        order_no:
          type: string
        payment_id:
          type: integer
          format: int64
        external_id:
          type:
            - string
            - 'null'
        channel:
          $ref: '#/components/schemas/PaymentChannel'
        status:
          $ref: '#/components/schemas/RefundStatus'
        amount:
          type: string
          description: 退款单金额
        currency:
          type: string
          description: 币种
        request_payload:
          type:
            - object
            - 'null'
          additionalProperties: true
          x-apifox-orders: []
          properties: {}
          x-apifox-ignore-properties: []
        response_payload:
          type:
            - object
            - 'null'
          additionalProperties: true
          x-apifox-orders: []
          properties: {}
          x-apifox-ignore-properties: []
        notify_payload:
          type:
            - object
            - 'null'
          additionalProperties: true
          x-apifox-orders: []
          properties: {}
          x-apifox-ignore-properties: []
        last_polled_at:
          type:
            - string
            - 'null'
          format: date-time
        last_notified_at:
          type:
            - string
            - 'null'
          format: date-time
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
      x-apifox-orders:
        - refund_id
        - refund_no
        - order_id
        - order_no
        - payment_id
        - external_id
        - channel
        - status
        - amount
        - currency
        - request_payload
        - response_payload
        - notify_payload
        - last_polled_at
        - last_notified_at
        - created_at
        - updated_at
      x-apifox-ignore-properties: []
      x-apifox-folder: payment
  responses:
    已创建:
      description: ''
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Result'
    参数错误:
      description: ''
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Result'
          examples:
            空值或格式错误:
              summary: 空值或格式错误
              value:
                success: false
                code: BAD_REQUEST
                message: 用户名不能为空
                timestamp: '2025-11-06 11:38:39'
    已接受:
      description: ''
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Result'
    重定向:
      description: ''
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Result'
    未鉴权:
      description: ''
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Result'
          examples:
            示例 1:
              summary: 示例 1
              value:
                success: false
                code: UNAUTHORIZED
                message: Unauthorized
                timestamp: '2025-11-15 14:23:57'
    权限不足:
      description: ''
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Result'
          examples:
            示例 1:
              summary: 示例 1
              value:
                success: false
                code: FORBIDDEN
                message: Access denied
                timestamp: '2025-11-06 17:31:36'
    未找到:
      description: ''
      content:
        application/json:
          schema:
            type: object
            properties: {}
    冲突:
      description: ''
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Result'
          examples:
            示例 1:
              summary: 示例 1
              value:
                success: false
                code: CONFLICT
                message: 邮箱已被使用
                timestamp: '2025-11-15 14:23:56'
    无法处理的实体:
      description: ''
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Result'
          examples:
            示例 1:
              summary: 示例 1
              value:
                success: false
                code: UNPROCESSABLE_ENTITY
                message: 验证码错误或已过期
                timestamp: '2025-11-06 15:28:11'
    服务器内部错误:
      description: ''
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Result'
    请求过多:
      description: ''
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Result'
          examples:
            示例 1:
              summary: 示例 1
              value:
                success: false
                code: TOO_MANY_REQUESTS
                message: 尝试次数过多, 请过段时间再试
                timestamp: '2025-11-15 14:25:35'
  securitySchemes: {}
servers: []
security: []
